<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Convertidor</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Convertidor de archivos</h2>

  <h3>JJ a Excel</h3>
  <input type="file" id="fileInputJJ" accept=".txt">
  <button onclick="procesarArchivoJJ()">Convertir</button>

  <h3>JP a Excel</h3>
  <input type="file" id="fileInputJP" accept=".txt">
  <button onclick="procesarArchivoJP()">Convertir</button>

  <h3>TXT Tabulado a Excel</h3>
  <input type="file" id="fileInputTab" accept=".txt">
  <button onclick="procesarArchivoTabulado()">Convertir</button>

  <h3>Excel a TXT Tabulado</h3>
  <input type="file" id="fileInputExcel" accept=".xlsx">
  <button onclick="convertirExcelATxt()">Convertir</button>
  
  <script>
    // --- CONFIGURACIÓN JJ ---
    const columnasJJ = [
      [0, 5], [5, 23], [23, 173], [173, 174], [174, 182], [182, 186],
      [186, 197], [197, 208], [208, 228], [228, 248], [248, 258], [258, 259],
      [259, 271], [271, 277], [277, 278], [278, 279], [279, 280], [280, 281],
      [281, 282], [282, 283], [283, 284], [284, 285], [285, 287], [287, 289],
      [289, 291], [291, 293], [293, 295], [295, 297], [297, 303], [303, 304],
      [304, 312], [312, 324], [324, 330], [330, 331], [331, 332], [332, 340],
      [340, 352], [352, 358], [358, 359], [359, 361], [361, 369], [369, 381],
      [381, 387], [387, 388], [388, 390], [390, 398], [398, 410], [410, 416],
      [416, 417], [417, 418], [418, 436], [436, 440], [440, 441]
    ];

    const encabezadosJJ = [
      "Cart", "Nro_Expte", "Caratula", "Carácter_ART", "Fecha_Notif", "Dto_Judicial",
      "CUIT", "CUIL", "Nro_Siniestro", "Nro_Seclo", "Nro_Litigio", "Monto_Indet",
      "Monto_Reclamado", "Incap_Reclamada", "Estudios_Méd", "Certif_Méd", "Examen_Físico",
      "Vínculo_Laboral", "Actuación_ART", "Conting_1", "Conting_2", "Conting_3",
      "Enfermedad_1", "Enfermedad_2", "Enfermedad_3", "Objeto_1", "Objeto_2", "Objeto_3",
      "Incap_Perito", "Sentencia_1ra", "Fecha_Sent_1ra", "Monto_Sent_1ra", "Incap_1ra",
      "Ajuste_Baremo_1ra", "Sentencia_2da", "Fecha_Sent_2da", "Monto_Sent_2da", "Incap_2da",
      "Ajuste_Baremo_2da", "Sent_Corte_Prov", "Fecha_Sent_CP", "Monto_Sent_CP", "Incap_CP",
      "Ajuste_Baremo_CP", "Sent_Corte_Sup", "Fecha_Sent_CS", "Monto_Sent_CS", "Incap_CS",
      "Ajuste_Baremo_CS", "Denuncia_Penal", "Expte_Penal", "Dto_Judicial_2", "Tipo_Operacion"
    ];

    // --- CONFIGURACIÓN JP ---
    const columnasJP = [
      [0, 5], [5, 23], [23, 43], [43, 45], [45, 46], [46, 57],
      [57, 77], [77, 127], [127, 177], [177, 227], [227, 277], [277, 278]
    ];

    const encabezadosJP = [
      "Cart", "Nro_Expte", "Nro_Seclo", "ID_Profesional", "Tipo", "CUIT", "Matrícula",
      "Apellido", "Nombre", "Domicilio", "Estudio_Jurídico", "Tipo_Op"
    ];

    // --- ENCABEZADO JYM ---
    const encabezadosTab = [
      "Cod", "RAJ", "Fecha Registro", "Tipo Registro", "Libro", "J o M",
      "Ramo (Op)", "Sub Ramo (Op)", "Tipo Daño (Op)", "Expte (Op)", "Fuero (Op)",
      "Juzgado (Op)", "Nro Juzgado (Op)", "Secretaria (Op)", "Actor", "Demandado",
      "Asunto", "CUIL", "Abogado ART (Op)", "CUIL (Op)", "Estudio ART (Op)", "CUIL (Op)",
      "Abogado PA", "Póliza", "Endoso", "Certificado", "Póliza (Op)", "Siniestro",
      "Fecha siniestro (Op)", "Fecha demanda", "Fecha monto", "Monto indet",
      "Monte demanda", "Moneda", "Tipo ART (Op)", "No seguro", "Fecha AO (Op)",
      "Fecha fin juicio (Op)", "Estado Procesal", "Pagos de cap e int",
      "Honorarios y gastos", "Total monto reservado",
      "Monto reservado bruto de reaseguro", "Monto diferencia reserva comparada",
      "Monto reservado no siniestros", "RAJ mediación", "Carácter ART", "Observaciones"
    ];

    function procesarArchivoJJ() {
      const input = document.getElementById('fileInputJJ');
      const archivo = input.files[0];
      if (!archivo) return alert("Seleccioná un archivo .txt primero");

      const lector = new FileReader();
      lector.onload = function(e) {
        let contenido = e.target.result.replace(/\r?\n/g, '');
        const datos = [encabezadosJJ];

        const totalRegistros = Math.floor(contenido.length / 441);
        for (let i = 0; i < totalRegistros; i++) {
          const inicio = i * 441;
          const bloque = contenido.slice(inicio, inicio + 441);
          const fila = columnasJJ.map(([start, end]) => bloque.slice(start, end).trim());
          datos.push(fila);
        }

        descargarExcel(datos, "Datos_JJ", "datos_JJ.xlsx");
      };
      lector.readAsText(archivo, 'UTF-8');
    }

    function procesarArchivoJP() {
      const input = document.getElementById('fileInputJP');
      const archivo = input.files[0];
      if (!archivo) return alert("Seleccioná un archivo .txt primero");

      const lector = new FileReader();
      lector.onload = function(e) {
        let contenido = e.target.result.replace(/\r?\n/g, '');
        const datos = [encabezadosJP];

        const totalRegistros = Math.floor(contenido.length / 278);
        for (let i = 0; i < totalRegistros; i++) {
          const inicio = i * 278;
          const bloque = contenido.slice(inicio, inicio + 278);
          if (/^\s*$/.test(bloque)) continue;
          const fila = columnasJP.map(([start, end]) => bloque.slice(start, end).trim());
          datos.push(fila);
        }

        descargarExcel(datos, "Datos_JP", "datos_JP.xlsx");
      };
      lector.readAsText(archivo, 'UTF-8');
    }

    function procesarArchivoTabulado() {
      const input = document.getElementById('fileInputTab');
      const archivo = input.files[0];
      if (!archivo) return alert("Seleccioná un archivo .txt tabulado primero");

      const lector = new FileReader();
      lector.onload = function(e) {
        const contenido = e.target.result;
        const lineas = contenido.split(/\r?\n/).filter(linea => linea.trim() !== "");
        const datos = [encabezadosTab];

        for (const linea of lineas) {
          const fila = linea.split('\t').map(campo => campo.trim());
          datos.push(fila);
        }

        descargarExcel(datos, "Datos_Tabulados", "datos_tabulados.xlsx");
      };
      lector.readAsText(archivo, 'UTF-8');
    }

    function convertirExcelATxt() {
      const input = document.getElementById('fileInputExcel');
      const archivo = input.files[0];
      if (!archivo) return alert("Seleccioná un archivo .xlsx primero");

      const lector = new FileReader();
      lector.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const primeraHoja = workbook.SheetNames[0];
        const hoja = workbook.Sheets[primeraHoja];
        const datos = XLSX.utils.sheet_to_json(hoja, { header: 1 });

        const lineasTxt = datos
          .filter(fila => fila.some(celda => celda !== undefined && celda !== null && celda.toString().trim() !== ''))
          .map(fila => fila.map(celda => (celda ?? "").toString().trim()).join('\t'))
          .join('\n');

        const blob = new Blob([lineasTxt], { type: "text/plain;charset=utf-8" });
        const enlace = document.createElement("a");
        enlace.href = URL.createObjectURL(blob);
        enlace.download = "convertido.txt";
        enlace.click();
      };
      lector.readAsArrayBuffer(archivo);
    }
    
    function descargarExcel(datos, nombreHoja, nombreArchivo) {
      const hoja = XLSX.utils.aoa_to_sheet(datos);
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, nombreHoja);
      XLSX.writeFile(libro, nombreArchivo);
    }
  </script>
</body>
</html>
